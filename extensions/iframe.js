// Name: Iframe
// ID: iframe
// Description: Display webpages or HTML over the stage.
// Context: "iframe" is an HTML element that lets websites embed other websites.
// License: MIT AND MPL-2.0

/* generated l10n code */Scratch.translate.setup({"fi":{"_It works!":"Toimii!","_close iframe":"sulje iframe","_height":"korkeus","_hide iframe":"piilota iframe","_iframe [MENU]":"iframen [MENU]","_interactive":"vuorovaikutteisuus","_resize behavior":"käytös kokoa muuttaessa","_scale":"skaalaus","_set iframe height to [HEIGHT]":"aseta iframen korkeudeksi [HEIGHT]","_set iframe interactive to [INTERACTIVE]":"iframen vuorovaikutteisuus on päällä =  [INTERACTIVE]","_set iframe resize behavior to [RESIZE]":"aseta iframen käytökseksi kokoa muuttaessa [RESIZE]","_set iframe width to [WIDTH]":"aseta iframen leveydeksi [WIDTH]","_set iframe x position to [X]":"aseta iframen x-sijainniksi [X]","_set iframe y position to [Y]":"aseta iframen y-sijainniksi [Y]","_show HTML [HTML]":"näytä HTML-koodi [HTML]","_show iframe":"näytä iframe","_show website [URL]":"näytä verkkosivusto [URL]","_url":"URL-osoite","_viewport":"kuvaportti","_visible":"näkyvyys","_width":"leveys"},"it":{"_It works!":"Funziona!","_close iframe":"chiudi iframe","_height":"altezza","_hide iframe":"nascondi iframe","_iframe [MENU]":"[MENU] dell'iframe","_interactive":"interattività","_resize behavior":"comportamento quando ridimensionato","_scale":"scala","_set iframe height to [HEIGHT]":"imposta larghezza dell'iframe a [HEIGHT]","_set iframe interactive to [INTERACTIVE]":"imposta interattività iframe a [INTERACTIVE]","_set iframe resize behavior to [RESIZE]":"imposta comportamento dell'iframe quando ridimensionato a [RESIZE]","_set iframe width to [WIDTH]":"imposta larghezza dell'iframe a [WIDTH]","_set iframe x position to [X]":"imposta posizione x dell'iframe a [X]","_set iframe y position to [Y]":"imposta posizione y dell'iframe a[Y]","_show HTML [HTML]":"mostra HTML [HTML]","_show iframe":"mostra iframe","_show website [URL]":"mostra sito [URL]","_visible":"visibilità","_width":"larghezza"},"ja":{"_Iframe":"埋め込み","_It works!":"うまく動作しています!","_close iframe":"ページを閉じる","_height":"高さ","_hide iframe":"ページを隠す","_iframe [MENU]":"ページの[MENU]","_interactive":"動きがあるか?","_resize behavior":"サイズ変更動作","_scale":"スケール","_set iframe height to [HEIGHT]":"ページの高さを[HEIGHT]にする","_set iframe interactive to [INTERACTIVE]":"ページが動いているかを[INTERACTIVE]にする","_set iframe resize behavior to [RESIZE]":"埋め込みのサイズ変更動作を[RESIZE]にする","_set iframe width to [WIDTH]":"ページの横幅を[WIDTH]にする","_set iframe x position to [X]":"ページのx座標を[X]にする","_set iframe y position to [Y]":"ページのy座標を[Y]にする","_show HTML [HTML]":"[HTML]のHTMLを表示する","_show iframe":"ページを表示する","_show website [URL]":"[URL]のウェブサイトを表示する","_url":"URL","_visible":"見えるか?","_width":"横幅"},"ko":{"_close iframe":"iframe 닫기","_height":"높이","_hide iframe":"iframe 숨기기","_iframe [MENU]":"iframe의 [MENU]","_interactive":"상호작용 여부","_resize behavior":"크기 조정 방식","_set iframe height to [HEIGHT]":"iframe 높이를 [HEIGHT](으)로 정하기","_set iframe interactive to [INTERACTIVE]":"iframe 상호작용 여부를 [INTERACTIVE](으)로 정하기","_set iframe resize behavior to [RESIZE]":"iframe 크기 조정 방식을 [RESIZE](으)로 정하기","_set iframe width to [WIDTH]":"iframe 넓이를 [WIDTH](으)로 정하기","_set iframe x position to [X]":"iframe x좌표를 [X](으)로 정하기","_set iframe y position to [Y]":"iframe y좌표를 [Y](으)로 정하기","_show HTML [HTML]":"HTML [HTML] 보이기","_show iframe":"iframe 보이기","_show website [URL]":"웹사이트 [URL] 보이기","_visible":"보임 여부","_width":"넓이"},"nb":{"_Iframe":"IFrame","_It works!":"Det fungerer!","_close iframe":"lukk iframe","_height":"høyde","_hide iframe":"skjul iframe","_interactive":"interaktiv","_resize behavior":"endre størrelsesoppførsel","_scale":"skala","_set iframe height to [HEIGHT]":"set iframe høyde til [HEIGHT]","_set iframe interactive to [INTERACTIVE]":"sett iframe interaktiv til [INTERACTIVE]","_set iframe resize behavior to [RESIZE]":"sett iframe resize oppførsel til [RESIZE]","_set iframe width to [WIDTH]":"set iframe bredde til [WIDTH]","_set iframe x position to [X]":"sett iframe x-posisjon til [X]","_set iframe y position to [Y]":"sett iframe y-posisjon til [Y]","_show HTML [HTML]":"vis HTML [HTML]","_show iframe":"vis iframe","_show website [URL]":"vis nettside [URL]","_viewport":"visningsområde","_visible":"synlig","_width":"bredde"},"nl":{"_It works!":"Het werkt!","_close iframe":"sluit iframe","_height":"hoogte","_hide iframe":"verberg iframe","_iframe [MENU]":"[MENU] van iframe","_interactive":"interactief?","_resize behavior":"formaatwijzigingsgedrag","_scale":"speelveld","_set iframe height to [HEIGHT]":"maak hoogte van iframe [HEIGHT]","_set iframe interactive to [INTERACTIVE]":"maak iframe interactief? [INTERACTIVE]","_set iframe resize behavior to [RESIZE]":"maak formaatwijzigingsgedrag van iframe [RESIZE]","_set iframe width to [WIDTH]":"maak breedte van iframe [WIDTH]","_set iframe x position to [X]":"maak x-positie van iframe [X]","_set iframe y position to [Y]":"maak y-positie van iframe [Y]","_show HTML [HTML]":"toon HTML [HTML]","_show iframe":"toon iframe","_show website [URL]":"toon website [URL]","_viewport":"beeldscherm","_visible":"zichtbaar?","_width":"breedte"},"pl":{"_height":"wysokość","_scale":"skala","_width":"szerokość"},"ru":{"_It works!":"Работает!","_close iframe":"закрыть iframe","_height":"высота","_hide iframe":"спрятать iframe","_interactive":"взаимодейственность","_resize behavior":"основное изменение размера","_scale":"размер","_set iframe height to [HEIGHT]":"задать высоту iframe в [HEIGHT]","_set iframe interactive to [INTERACTIVE]":"задать взаимодействие с iframe на [INTERACTIVE]","_set iframe resize behavior to [RESIZE]":"задать поведение изменения размера iframe на [RESIZE]","_set iframe width to [WIDTH]":"задать ширину iframe в [WIDTH]","_set iframe x position to [X]":"задать позицию iframe x в [X]","_set iframe y position to [Y]":"задать позицию iframe y в [Y]","_show HTML [HTML]":"показать HTML [HTML]","_show iframe":"показать iframe","_show website [URL]":"показать вебсайт [URL]","_viewport":"область просмотра","_visible":"виден","_width":"ширина"},"uk":{"_height":"висота","_width":"ширина"},"zh-cn":{"_Iframe":"内嵌框架","_It works!":"能用！","_close iframe":"退出 iframe","_height":"高度","_hide iframe":"隐藏 iframe","_iframe [MENU]":"iframe 的[MENU]","_interactive":"可以与鼠标交互？","_resize behavior":"调整大小行为","_scale":"规模","_set iframe height to [HEIGHT]":"设置 iframe 的高度为[HEIGHT]","_set iframe interactive to [INTERACTIVE]":"设置 iframe 交互为[INTERACTIVE]","_set iframe resize behavior to [RESIZE]":"设置 iframe 调整大小行为为 [RESIZE]","_set iframe width to [WIDTH]":"设置 iframe 的宽度为[WIDTH]","_set iframe x position to [X]":"设置 iframe x坐标为[X]","_set iframe y position to [Y]":"设置 iframe y坐标为[Y]","_show HTML [HTML]":"显示来自文本[HTML]的网页","_show iframe":"显示 iframe","_show website [URL]":"显示来自URL[URL]的网页","_url":"URL","_viewport":"视点","_visible":"显示状态","_width":"宽度"}});/* end generated l10n code */(function (Scratch) {
  "use strict";

  /** @type {HTMLIFrameElement|null} */
  let iframe = null;
  let overlay = null;

  const featurePolicy = {
    accelerometer: "'none'",
    "ambient-light-sensor": "'none'",
    battery: "'none'",
    camera: "'none'",
    "display-capture": "'none'",
    "document-domain": "'none'",
    "encrypted-media": "'none'",
    fullscreen: "'none'",
    geolocation: "'none'",
    gyroscope: "'none'",
    magnetometer: "'none'",
    microphone: "'none'",
    midi: "'none'",
    payment: "'none'",
    "picture-in-picture": "'none'",
    "publickey-credentials-get": "'none'",
    "speaker-selection": "'none'",
    usb: "'none'",
    vibrate: "'none'",
    vr: "'none'",
    "screen-wake-lock": "'none'",
    "web-share": "'none'",
    "interest-cohort": "'none'",
  };

  const SANDBOX = [
    "allow-same-origin",
    "allow-scripts",
    "allow-forms",
    "allow-modals",
    "allow-popups",

    // The big one we don't want to include is allow-top-navigation
  ];

  let x = 0;
  let y = 0;
  let width = -1; // negative means default
  let height = -1; // negative means default
  let interactive = true;
  let resizeBehavior = "scale";

  const updateFrameAttributes = () => {
    if (!iframe) {
      return;
    }

    iframe.style.pointerEvents = interactive ? "auto" : "none";

    const { stageWidth, stageHeight } = Scratch.vm.runtime;
    const effectiveWidth = width >= 0 ? width : stageWidth;
    const effectiveHeight = height >= 0 ? height : stageHeight;

    if (resizeBehavior === "scale") {
      iframe.style.width = `${effectiveWidth}px`;
      iframe.style.height = `${effectiveHeight}px`;

      iframe.style.transform = `translate(${-effectiveWidth / 2 + x}px, ${
        -effectiveHeight / 2 - y
      }px)`;
      iframe.style.top = "0";
      iframe.style.left = "0";
    } else {
      // As the stage is resized in fullscreen mode, only % can be relied upon
      iframe.style.width = `${(effectiveWidth / stageWidth) * 100}%`;
      iframe.style.height = `${(effectiveHeight / stageHeight) * 100}%`;

      iframe.style.transform = "";
      iframe.style.top = `${
        (0.5 - effectiveHeight / 2 / stageHeight - y / stageHeight) * 100
      }%`;
      iframe.style.left = `${
        (0.5 - effectiveWidth / 2 / stageWidth + x / stageWidth) * 100
      }%`;
    }
  };

  const getOverlayMode = () =>
    resizeBehavior === "scale" ? "scale-centered" : "manual";

  const createFrame = (src) => {
    iframe = document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    iframe.style.position = "absolute";
    iframe.setAttribute("sandbox", SANDBOX.join(" "));
    iframe.setAttribute(
      "allow",
      Object.entries(featurePolicy)
        .map(([name, permission]) => `${name} ${permission}`)
        .join("; ")
    );
    iframe.setAttribute("allowtransparency", "true");
    iframe.setAttribute("allowtransparency", "true");
    iframe.setAttribute("src", src);

    overlay = Scratch.renderer.addOverlay(iframe, getOverlayMode());
    updateFrameAttributes();
  };

  const closeFrame = () => {
    if (iframe) {
      Scratch.renderer.removeOverlay(iframe);
      iframe = null;
      overlay = null;
    }
  };

  Scratch.vm.on("STAGE_SIZE_CHANGED", updateFrameAttributes);

  Scratch.vm.runtime.on("RUNTIME_DISPOSED", closeFrame);

  class IframeExtension {
    getInfo() {
      return {
        name: Scratch.translate("Iframe"),
        id: "iframe",
        blocks: [
          {
            opcode: "display",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("show website [URL]"),
            arguments: {
              URL: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "https://extensions.turbowarp.org/hello.html",
              },
            },
          },
          {
            opcode: "displayHTML",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("show HTML [HTML]"),
            arguments: {
              HTML: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: `<h1>${Scratch.translate("It works!")}</h1>`,
              },
            },
          },
          "---",
          {
            opcode: "show",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("show iframe"),
          },
          {
            opcode: "hide",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("hide iframe"),
          },
          {
            opcode: "close",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("close iframe"),
          },
          "---",
          {
            opcode: "get",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("iframe [MENU]"),
            arguments: {
              MENU: {
                type: Scratch.ArgumentType.STRING,
                menu: "getMenu",
              },
            },
          },
          {
            opcode: "setX",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set iframe x position to [X]"),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
          },
          {
            opcode: "setY",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set iframe y position to [Y]"),
            arguments: {
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
          },
          {
            opcode: "setWidth",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set iframe width to [WIDTH]"),
            arguments: {
              WIDTH: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: Scratch.vm.runtime.stageWidth,
              },
            },
          },
          {
            opcode: "setHeight",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set iframe height to [HEIGHT]"),
            arguments: {
              HEIGHT: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: Scratch.vm.runtime.stageHeight,
              },
            },
          },
          {
            opcode: "setInteractive",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set iframe interactive to [INTERACTIVE]"),
            arguments: {
              INTERACTIVE: {
                type: Scratch.ArgumentType.STRING,
                menu: "interactiveMenu",
              },
            },
          },
          {
            opcode: "setResize",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set iframe resize behavior to [RESIZE]"),
            arguments: {
              RESIZE: {
                type: Scratch.ArgumentType.STRING,
                menu: "resizeMenu",
              },
            },
          },
        ],
        menus: {
          getMenu: {
            acceptReporters: true,
            items: [
              Scratch.translate("url"),
              Scratch.translate("visible"),
              "x",
              "y",
              Scratch.translate("width"),
              Scratch.translate("height"),
              Scratch.translate("interactive"),
              Scratch.translate("resize behavior"),
            ],
          },
          interactiveMenu: {
            acceptReporters: true,
            items: [
              // The getter blocks will return English regardless of translating these
              "true",
              "false",
            ],
          },
          resizeMenu: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("scale"),
                value: "scale",
              },
              {
                text: Scratch.translate("viewport"),
                value: "viewport",
              },
            ],
          },
        },
      };
    }

    async display({ URL }) {
      closeFrame();
      if (await Scratch.canEmbed(URL)) {
        createFrame(Scratch.Cast.toString(URL));
      }
    }

    async displayHTML({ HTML }) {
      closeFrame();
      const url = `data:text/html;,${encodeURIComponent(
        Scratch.Cast.toString(HTML)
      )}`;
      if (await Scratch.canEmbed(url)) {
        createFrame(url);
      }
    }

    show() {
      if (iframe) {
        iframe.style.display = "";
      }
    }

    hide() {
      if (iframe) {
        iframe.style.display = "none";
      }
    }

    close() {
      closeFrame();
    }

    get({ MENU }) {
      MENU = Scratch.Cast.toString(MENU);
      if (MENU === "url") {
        if (iframe) return iframe.getAttribute("src");
        return "";
      } else if (MENU === "visible") {
        return !!iframe && iframe.style.display !== "none";
      } else if (MENU === "x") {
        return x;
      } else if (MENU === "y") {
        return y;
      } else if (MENU === "width") {
        return width >= 0 ? width : Scratch.vm.runtime.stageWidth;
      } else if (MENU === "height") {
        return height >= 0 ? height : Scratch.vm.runtime.stageHeight;
      } else if (MENU === "interactive") {
        return interactive;
      } else if (MENU === "resize behavior") {
        return resizeBehavior;
      } else {
        return "";
      }
    }

    setX({ X }) {
      x = Scratch.Cast.toNumber(X);
      updateFrameAttributes();
    }

    setY({ Y }) {
      y = Scratch.Cast.toNumber(Y);
      updateFrameAttributes();
    }

    setWidth({ WIDTH }) {
      width = Scratch.Cast.toNumber(WIDTH);
      updateFrameAttributes();
    }

    setHeight({ HEIGHT }) {
      height = Scratch.Cast.toNumber(HEIGHT);
      updateFrameAttributes();
    }

    setInteractive({ INTERACTIVE }) {
      interactive = Scratch.Cast.toBoolean(INTERACTIVE);
      updateFrameAttributes();
    }

    setResize({ RESIZE }) {
      if (RESIZE === "scale" || RESIZE === "viewport") {
        resizeBehavior = RESIZE;
        if (overlay) {
          overlay.mode = getOverlayMode();
          Scratch.renderer._updateOverlays();
          updateFrameAttributes();
        }
      }
    }
  }

  Scratch.extensions.register(new IframeExtension());
})(Scratch);
