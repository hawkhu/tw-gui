// Name: More Motion
// ID: nkmoremotion
// Description: More motion-related blocks.
// By: NamelessCat <https://scratch.mit.edu/users/NamelessCat/>
// License: MIT

/* generated l10n code */Scratch.translate.setup({"de":{"_More Motion":"Mehr Bewegung"},"fi":{"_More Motion":"Laajennettu liike","_change x: [X] y: [Y]":"muuta sijaintia arvoilla x: [X] y: [Y]","_costume height":"asusteen korkeus","_costume width":"asusteen leveys","_direction to x: [X] y: [Y]":"suunta sijaintiin x: [X] y: [Y]","_distance from x: [X] y: [Y]":"etäisyys sijainnista x: [X] y: [Y]","_height":"korkeus","_manually fence":"älä mene esiintymislavan ulkopuollelle","_move [PERCENT]% of the way to x: [X] y: [Y]":"liiku [PERCENT] % matkasta sijaintiin x: [X] y: [Y]","_move [STEPS] steps towards x: [X] y: [Y]":"liiku [STEPS] askelta kohti x: [X] y: [Y]","_point towards x: [X] y: [Y]":"osoita kohti x: [X] y: [Y]","_rotation style":"kiertotyyli","_sprite [WHAT]":"hahmon [WHAT]","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"koskettaako nelikulmiota x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?","_touching x: [X] y: [Y]?":"koskettaako sijaintia x: [X] y: [Y]?","_width":"leveys"},"it":{"_More Motion":"Movimento Plus","_change x: [X] y: [Y]":"cambia x di [X] y di [Y]","_costume height":"altezza costume","_costume width":"larghezza costume","_direction to x: [X] y: [Y]":"direzione verso x: [X] y: [Y]","_distance from x: [X] y: [Y]":"distanza da x: [X] y: [Y]","_height":"altezza","_manually fence":"impedisci sprite fuori Stage","_move [PERCENT]% of the way to x: [X] y: [Y]":"percorri [PERCENT]% della distanza da x: [X] y: [Y]","_move [STEPS] steps towards x: [X] y: [Y]":"fai [STEPS] passi verso x: [X] y: [Y]","_point towards x: [X] y: [Y]":"punta verso x: [X] y: [Y]","_rotation style":"stile rotazione","_sprite [WHAT]":"[WHAT] dello sprite","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"sta toccando rettangolo x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]","_touching x: [X] y: [Y]?":"sta toccando x: [X] y: [Y]","_width":"larghezza"},"ja":{"_More Motion":"さらなる動き","_change x: [X] y: [Y]":"x座標を[X]、y座標を[Y]ずつ変える","_costume height":"コスチュームの高さ","_costume width":"コスチュームの幅","_direction to x: [X] y: [Y]":"x座標[X]y座標[Y]への向き","_distance from x: [X] y: [Y]":"x座標[X]y座標[Y]までの距離","_height":"高さ","_manually fence":"スプライトを画面内に入れる","_move [PERCENT]% of the way to x: [X] y: [Y]":"x座標[X]y座標[Y]へ向かう間の[PERCENT]%の道のり分動かす","_move [STEPS] steps towards x: [X] y: [Y]":"x座標[X]y座標[Y]に向かって[STEPS]歩動かす","_point towards x: [X] y: [Y]":"x座標[X]、y座標[Y]の位置を向く","_rotation style":"回転方法","_sprite [WHAT]":"スプライトの[WHAT]","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"四角形 x1[X1]y1[Y1]x2[X2]y2[Y2]に触れた","_touching x: [X] y: [Y]?":"x座標[X]y座標[Y]に触れた","_width":"横幅"},"ko":{"_More Motion":"추가 동작","_change x: [X] y: [Y]":"x:[X] y:[Y] (으)로 이동하기","_costume height":"모양 높이","_costume width":"모양 넓이","_direction to x: [X] y: [Y]":"x:[X] y:[Y] (으)로의 방향","_distance from x: [X] y: [Y]":"x:[X] y:[Y] 까지의 거리","_height":"높이","_move [PERCENT]% of the way to x: [X] y: [Y]":"x:[X] y:[Y] (으)로 [PERCENT]% 만큼 이동하기","_move [STEPS] steps towards x: [X] y: [Y]":"x:[X] y:[Y] (으)로 [STEPS]번 나눠 이동하기 ","_point towards x: [X] y: [Y]":"x:[X] y:[Y] 쪽 바라보기","_rotation style":"회전 방식","_sprite [WHAT]":"스프라이트 [WHAT]","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"사각형 x1:[X1] y1:[Y1] x2:[X2] y2:[Y2] 에 닿았는가?","_touching x: [X] y: [Y]?":"x:[X] y:[Y] 에 닿았는가?","_width":"넓이"},"nb":{"_More Motion":"Mer Bevegelse","_change x: [X] y: [Y]":"endre x: [X] y: [Y]","_costume height":"kostyme høyde","_costume width":"kostymebredde","_direction to x: [X] y: [Y]":"retning til x: [X] y: [Y]","_distance from x: [X] y: [Y]":"avstand fra x: [X] y: [Y]","_height":"høyde","_manually fence":"manuelt gjerde","_move [PERCENT]% of the way to x: [X] y: [Y]":"flytt [PERCENT]% av veien til x: [X] y: [Y]","_move [STEPS] steps towards x: [X] y: [Y]":"flytt [STEPS] trinn mot x: [X] y: [Y]","_point towards x: [X] y: [Y]":"peker mot x: [X] y: [Y]","_rotation style":"rotasjonsstil","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"berøring rektangel x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?","_touching x: [X] y: [Y]?":"berøring x: [X] y: [Y]?","_width":"bredde"},"nl":{"_More Motion":"Beweging uitgebreid","_change x: [X] y: [Y]":"verander x: [X] y: [Y]","_costume height":"uiterlijkhoogte","_costume width":"uiterlijkbreedte","_direction to x: [X] y: [Y]":"richting naar x: [X] y: [Y]","_distance from x: [X] y: [Y]":"afstand tot x: [X] y: [Y]","_height":"hoogte","_manually fence":"kom terug in het scherm","_move [PERCENT]% of the way to x: [X] y: [Y]":"beweeg [PERCENT]% richting x: [X] y: [Y]","_move [STEPS] steps towards x: [X] y: [Y]":"neem [STEPS] stappen richting x: [X] y: [Y]","_point towards x: [X] y: [Y]":"richt naar x: [X] y: [Y]","_rotation style":"draaistijl","_sprite [WHAT]":"[WHAT] van sprite","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"raak ik een punt tussen x1: [X1] y1: [Y1] en x2: [X2] y2: [Y2]?","_touching x: [X] y: [Y]?":"raak ik x: [X] y: [Y]?","_width":"breedte"},"pl":{"_height":"wysokość","_width":"szerokość"},"ru":{"_More Motion":"Больше Движения","_change x: [X] y: [Y]":"изменить x: [X] y: [Y]","_costume height":"высота костюма","_costume width":"ширина костюма","_direction to x: [X] y: [Y]":"поворот к x: [X] y: [Y]","_distance from x: [X] y: [Y]":"дистанция от x: [X] y: [Y]","_height":"высота","_manually fence":"ручное ограждение","_move [PERCENT]% of the way to x: [X] y: [Y]":"идти [PERCENT]% шага к x: [X] y: [Y]","_move [STEPS] steps towards x: [X] y: [Y]":"идти [STEPS] шагов к x: [X] y: [Y]","_point towards x: [X] y: [Y]":"указать на x: [X] y: [Y]","_rotation style":"стиль поворота","_sprite [WHAT]":"спрайт [WHAT]","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"касается прямоугольника x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]","_touching x: [X] y: [Y]?":"касается x: [X] y: [Y]?","_width":"ширина"},"tr":{"_More Motion":"Daha fazla Hareket"},"uk":{"_More Motion":"Більше Рухів","_change x: [X] y: [Y]":"змінити x: [X] y: [Y]","_costume height":"висота образу","_costume width":"ширина образу","_direction to x: [X] y: [Y]":"напрям до x: [X] y: [Y]","_distance from x: [X] y: [Y]":"відстань до x: [X] y: [Y]","_height":"висота","_manually fence":"не пускати за межі сцени","_move [PERCENT]% of the way to x: [X] y: [Y]":"йти [PERCENT]% відстані до x: [X] y: [Y]","_move [STEPS] steps towards x: [X] y: [Y]":"йти [STEPS] кроків до x: [X] y: [Y]","_point towards x: [X] y: [Y]":"повернути в напрямку до x: [X] y: [Y]","_rotation style":"стиль обертання","_sprite [WHAT]":"[WHAT] спрайту","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"торкається прямокутника x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?","_touching x: [X] y: [Y]?":"торкається x: [X] y: [Y]?","_width":"ширина"},"zh-cn":{"_More Motion":"更多运动","_change x: [X] y: [Y]":"x坐标增加[X]，y坐标增加[Y]","_costume height":"造型高度","_costume width":"造型宽度","_direction to x: [X] y: [Y]":"角色位置到x[X] y[Y]的方向","_distance from x: [X] y: [Y]":"角色位置到x[X] y[Y]的距离","_height":"高度","_manually fence":"回到舞台","_move [PERCENT]% of the way to x: [X] y: [Y]":"向x[X] y[Y]移动[PERCENT]%的路程","_move [STEPS] steps towards x: [X] y: [Y]":"向x[X] y[Y]移动[STEPS]步","_point towards x: [X] y: [Y]":"面向x[X] y[Y]","_rotation style":"旋转模式","_sprite [WHAT]":"角色的[WHAT]","_touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?":"位于从x[X1] y[Y1] 到x[X2] y[Y2]的区域内？","_touching x: [X] y: [Y]?":"触碰坐标x[X] y[Y]？","_width":"宽度"}});/* end generated l10n code */(function (Scratch) {
  "use strict";

  if (!Scratch.extensions.unsandboxed) {
    throw new Error("More Motion must run unsandboxed");
  }

  // @ts-expect-error - not typed yet
  const Rectangle = Scratch.vm.renderer.exports.Rectangle;

  class nkmoremotion {
    getInfo() {
      return {
        id: "nkmoremotion",
        name: Scratch.translate("More Motion"),
        color1: "#4c97ff",
        color2: "#3373cc",
        blocks: [
          {
            filter: [Scratch.TargetType.STAGE],
            blockType: Scratch.BlockType.LABEL,
            // We can copy this translation from scratch-blocks
            text:
              typeof ScratchBlocks !== "undefined"
                ? ScratchBlocks.Msg["MOTION_STAGE_SELECTED"]
                : // This is just fallback for non-editor environments, don't need to translate
                  "Stage selected: no motion blocks",
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "changexy",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("change x: [X] y: [Y]"),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "pointto",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("point towards x: [X] y: [Y]"),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "rotationStyle",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("rotation style"),
            disableMonitor: true,
            extensions: ["colours_motion"],
          },
          "---",
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "fence",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate({
              default: "manually fence",
              description:
                "This blocks forces the sprite to be onscreen if it moved offscreen.",
            }),
            extensions: ["colours_motion"],
          },
          "---",
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "steptowards",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("move [STEPS] steps towards x: [X] y: [Y]"),
            arguments: {
              STEPS: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "10",
              },
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "tweentowards",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate(
              "move [PERCENT]% of the way to x: [X] y: [Y]"
            ),
            arguments: {
              PERCENT: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "10",
              },
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
          },
          "---",
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "directionto",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("direction to x: [X] y: [Y]"),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
            hideFromPalette: true,
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "directionto2",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("direction to x: [X] y: [Y]"),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "distanceto",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("distance from x: [X] y: [Y]"),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "spritewh",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("sprite [WHAT]"),
            disableMonitor: true,
            arguments: {
              WHAT: {
                type: Scratch.ArgumentType.STRING,
                menu: "WHAT",
              },
            },
          },
          "---",
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "touchingxy",
            blockType: Scratch.BlockType.BOOLEAN,
            text: Scratch.translate("touching x: [X] y: [Y]?"),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
            extensions: ["colours_motion"],
          },
          {
            filter: [Scratch.TargetType.SPRITE],
            opcode: "touchingrect",
            blockType: Scratch.BlockType.BOOLEAN,
            text: Scratch.translate(
              "touching rectangle x1: [X1] y1: [Y1] x2: [X2] y2: [Y2]?"
            ),
            arguments: {
              X1: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "-100",
              },
              Y1: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "-100",
              },
              X2: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "100",
              },
              Y2: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "100",
              },
            },
            extensions: ["colours_motion"],
          },
        ],
        menus: {
          WHAT: {
            acceptreporters: true,
            items: [
              {
                text: Scratch.translate("width"),
                value: "width",
              },
              {
                text: Scratch.translate("height"),
                value: "height",
              },
              {
                text: Scratch.translate("costume width"),
                value: "costume width",
              },
              {
                text: Scratch.translate("costume height"),
                value: "costume height",
              },
            ],
          },
        },
      };
    }

    changexy(args, util) {
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      util.target.setXY(util.target.x + x, util.target.y + y);
    }

    pointto(args, util) {
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      util.target.setDirection(
        (180 / Math.PI) * Math.atan2(x - util.target.x, y - util.target.y)
      );
    }

    rotationStyle(args, util) {
      return util.target.rotationStyle;
    }

    fence(args, util) {
      const newpos = Scratch.vm.renderer.getFencedPositionOfDrawable(
        util.target.drawableID,
        [util.target.x, util.target.y]
      );
      util.target.setXY(newpos[0], newpos[1]);
    }

    directionto(args, util) {
      // Old version, returns values from -90 to 270
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      if (util.target.y > y) {
        return (
          (180 / Math.PI) *
            Math.atan((x - util.target.x) / (y - util.target.y)) +
          180
        );
      } else {
        return (
          (180 / Math.PI) * Math.atan((x - util.target.x) / (y - util.target.y))
        );
      }
    }

    directionto2(args, util) {
      // New version, returns values from -180 to 180, like Scratch direction reporter.
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      return (180 / Math.PI) * Math.atan2(x - util.target.x, y - util.target.y);
    }

    distanceto(args, util) {
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      // Shoutout to Pythagoras!
      return Math.sqrt((x - util.target.x) ** 2 + (y - util.target.y) ** 2);
    }

    steptowards(args, util) {
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      const steps = Scratch.Cast.toNumber(args.STEPS);
      const val =
        steps / Math.sqrt((x - util.target.x) ** 2 + (y - util.target.y) ** 2);
      if (val >= 1) {
        util.target.setXY(x, y);
      } else {
        util.target.setXY(
          (x - util.target.x) * val + util.target.x,
          (y - util.target.y) * val + util.target.y
        );
      }
    }

    tweentowards(args, util) {
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      const val = Scratch.Cast.toNumber(args.PERCENT);
      // Essentially a smooth glide script.
      util.target.setXY(
        (x - util.target.x) * (val / 100) + util.target.x,
        (y - util.target.y) * (val / 100) + util.target.y
      );
    }

    touchingrect(args, util) {
      let left = Scratch.Cast.toNumber(args.X1);
      let right = Scratch.Cast.toNumber(args.X2);
      let bottom = Scratch.Cast.toNumber(args.Y1);
      let top = Scratch.Cast.toNumber(args.Y2);

      // Fix argument order if they got it backwards
      if (left > right) {
        let temp = left;
        left = right;
        right = temp;
      }
      if (bottom > top) {
        let temp = bottom;
        bottom = top;
        bottom = temp;
      }

      const drawable =
        Scratch.vm.renderer._allDrawables[util.target.drawableID];
      if (!drawable) {
        return false;
      }

      // See renderer.isTouchingDrawables

      const drawableBounds = drawable.getFastBounds();
      drawableBounds.snapToInt();

      const containsBounds = new Rectangle();
      containsBounds.initFromBounds(left, right, bottom, top);
      containsBounds.snapToInt();

      if (!containsBounds.intersects(drawableBounds)) {
        return false;
      }

      drawable.updateCPURenderAttributes();

      const intersectingBounds = Rectangle.intersect(
        drawableBounds,
        containsBounds
      );
      for (let x = intersectingBounds.left; x < intersectingBounds.right; x++) {
        for (
          let y = intersectingBounds.bottom;
          y < intersectingBounds.top;
          y++
        ) {
          // technically should be a twgl vec3, but does not actually need to be
          if (drawable.isTouching([x, y])) {
            return true;
          }
        }
      }
      return false;
    }

    touchingxy(args, util) {
      const x = Scratch.Cast.toNumber(args.X);
      const y = Scratch.Cast.toNumber(args.Y);
      const drawable =
        Scratch.vm.renderer._allDrawables[util.target.drawableID];
      if (!drawable) {
        return false;
      }
      // Position should technically be a twgl vec3, but it doesn't actually need to be
      drawable.updateCPURenderAttributes();
      return drawable.isTouching([x, y]);
    }

    spritewh(args, util) {
      if (args.WHAT === "width" || args.WHAT === "height") {
        const bounds = Scratch.vm.renderer.getBounds(util.target.drawableID);
        if (args.WHAT === "width") {
          return Math.ceil(bounds.width);
        } else {
          return Math.ceil(bounds.height);
        }
      } else if (
        args.WHAT === "costume width" ||
        args.WHAT === "costume height"
      ) {
        const costume = util.target.sprite.costumes[util.target.currentCostume];
        if (args.WHAT === "costume width") {
          return Math.ceil(costume.size[0]);
        } else {
          return Math.ceil(costume.size[1]);
        }
      }
    }
  }

  Scratch.extensions.register(new nkmoremotion());
})(Scratch);
