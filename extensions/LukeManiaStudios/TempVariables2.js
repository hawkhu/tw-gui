// Name: Temporary Variables
// ID: lmsTempVars2
// Description: Create disposable runtime or thread variables.
// By: LilyMakesThings <https://scratch.mit.edu/users/LilyMakesThings/>
// License: MIT AND LGPL-3.0

/* generated l10n code */Scratch.translate.setup({"de":{"_Temporary Variables":"Temporäre Variablen"},"fi":{"_Runtime Variables":"Ajonaikaiset muuttujat","_Temporary Variables":"Väliaikaiset muuttujat","_Thread Variables":"Säiemuuttujat","_active runtime variables":"käytössä olevat ajonaikaiset muuttujat","_active thread variables":"käytössä olevat säiemuuttujat","_change runtime var [VAR] by [NUM]":"lisää ajonaikaiseen muuttujaan [VAR] arvo [NUM]","_change thread var [VAR] by [NUM]":"lisää säiemuuttujaan [VAR] arvo [NUM]","_delete all runtime variables":"poista kaikki ajonaikaiset muuttujat","_delete runtime var [VAR]":"poista ajonaikainen muuttuja [VAR]","_for [VAR] in [NUM]":"toista [NUM] kertaa ja laske säiemuuttujalla [VAR]","_runtime var [VAR]":"ajonaikainen muuttuja [VAR]","_runtime var [VAR] exists?":"onko ajonaikainen muuttuja [VAR] olemassa?","_set runtime var [VAR] to [STRING]":"aseta ajonaikainen muuttuja [VAR] arvoon [STRING] ","_set thread var [VAR] to [STRING]":"aseta säiemuuttuja [VAR] arvoon [STRING]","_thread var [VAR]":"säiemuuttuja [VAR]","_thread var [VAR] exists?":"onko säiemuuttuja [VAR] olemassa?"},"it":{"_Temporary Variables":"Variabili Temporanee"},"ja":{"_Runtime Variables":"ランタイム変数","_Temporary Variables":"一時変数","_Thread Variables":"スレッド変数","_active runtime variables":"アクティブなランタイム変数","_active thread variables":"アクティブなスレッド変数","_change runtime var [VAR] by [NUM]":"ランタイム変数[VAR]を[NUM]ずつ変える","_change thread var [VAR] by [NUM]":"スレッド変数[VAR]を[NUM]ずつ変える","_delete all runtime variables":"すべてのランタイム変数を削除する","_delete runtime var [VAR]":"ランタイム変数[VAR]を削除する","_for [VAR] in [NUM]":"[NUM]の要素を[VAR]に入れて繰り返す","_runtime var [VAR]":"ランタイム変数[VAR]","_runtime var [VAR] exists?":"ランタイム変数[VAR]が存在している","_set runtime var [VAR] to [STRING]":"ランタイム変数[VAR]を[STRING]にする","_set thread var [VAR] to [STRING]":"スレッド変数[VAR]を[STRING]にする","_thread var [VAR]":"スレッド変数[VAR]","_thread var [VAR] exists?":"スレッド変数[VAR]は存在している？"},"ko":{"_Runtime Variables":"런타임 변수","_Temporary Variables":"일시적 변수","_Thread Variables":"스레드 변수","_active runtime variables":"활성화된 런타임 변수 목록","_active thread variables":"활성화된 스레드 변수 목록","_change runtime var [VAR] by [NUM]":"런타임 변수 [VAR]을(를) [NUM]만큼 바꾸기","_change thread var [VAR] by [NUM]":"스레드 변수 [VAR]을(를) [NUM]만큼 바꾸기","_delete all runtime variables":"모든 런타임 변수 삭제하기","_delete runtime var [VAR]":"런타임 변수 [VAR] 삭제하기","_for [VAR] in [NUM]":"[NUM]만큼 [VAR](으)로 순회하기","_runtime var [VAR]":"런타임 변수 [VAR]","_runtime var [VAR] exists?":"런타임 변수 [VAR]이(가) 존재하는가?","_set runtime var [VAR] to [STRING]":"런타임 변수 [VAR]을(를) [STRING](으)로 정하기","_set thread var [VAR] to [STRING]":"스레드 변수 [VAR]을(를) [STRING](으)로 정하기","_thread var [VAR]":"스레드 변수 [VAR]","_thread var [VAR] exists?":"스레드 변수 [VAR]이(가) 존재하는가?"},"nb":{"_Temporary Variables":"Midlertidige variabler"},"nl":{"_Runtime Variables":"Looptijdvariabelen","_Temporary Variables":"Tijdelijke variabelen","_Thread Variables":"Threadvariabelen","_active runtime variables":"actieve looptijdvariabelen","_active thread variables":"actieve threadvariabelen","_change runtime var [VAR] by [NUM]":"verander looptijdvar. [VAR] met [NUM]","_change thread var [VAR] by [NUM]":"verander threadvar. [VAR] met [NUM]","_delete all runtime variables":"verwijder alle looptijdvariabelen","_delete runtime var [VAR]":"verwijder looptijdvar. [VAR]","_for [VAR] in [NUM]":"voor elke [VAR] in [NUM]","_runtime var [VAR]":"looptijdvar. [VAR]","_runtime var [VAR] exists?":"looptijdvar. [VAR] bestaat?","_set runtime var [VAR] to [STRING]":"maak looptijdvar. [VAR] [STRING]","_set thread var [VAR] to [STRING]":"maak threadvar. [VAR] [STRING]","_thread var [VAR]":"threadvar. [VAR]","_thread var [VAR] exists?":"threadvar. [VAR] bestaat?"},"ru":{"_Runtime Variables":"Время Выполнения Переменных","_Temporary Variables":"Временные Переменные","_Thread Variables":"Переменные Ветки","_active runtime variables":"активные переменные с временем выполнения","_active thread variables":"активные веточные переменные","_change runtime var [VAR] by [NUM]":"изменить время выполнения переменной [VAR] в [NUM]","_change thread var [VAR] by [NUM]":"изменить веточную переменную [VAR] на [NUM]","_delete all runtime variables":"удалить все переменные с временем выполнения","_delete runtime var [VAR]":"удалить переменную [VAR] с временем выполнения","_for [VAR] in [NUM]":"повторить [VAR] раз [NUM]","_runtime var [VAR]":"время выполнения переменной [VAR]","_runtime var [VAR] exists?":"время выполнения для переменной [VAR] существует?","_set runtime var [VAR] to [STRING]":"задать время выполнения переменной [VAR] в [STRING]","_set thread var [VAR] to [STRING]":"задать веточную переменную [VAR] в [STRING]","_thread var [VAR]":"веточная переменная [VAR]","_thread var [VAR] exists?":"веточная переменная [VAR] существует?"},"tr":{"_Temporary Variables":"Geçici Değişkenler"},"uk":{"_Temporary Variables":"Тимчасові Змінні"},"zh-cn":{"_Runtime Variables":"临时变量","_Temporary Variables":"临时变量","_Thread Variables":"线程变量","_active runtime variables":"所有临时变量","_active thread variables":"所有线程变量","_change runtime var [VAR] by [NUM]":"将临时变量[VAR]增加[NUM]","_change thread var [VAR] by [NUM]":"将线程变量[VAR]增加[NUM]","_delete all runtime variables":"删除所有临时变量","_delete runtime var [VAR]":"删除临时变量[VAR]","_for [VAR] in [NUM]":"对于[NUM]中的每个线程变量[VAR]","_runtime var [VAR]":"临时变量[VAR]","_runtime var [VAR] exists?":"临时变量[VAR]是否存在？","_set runtime var [VAR] to [STRING]":"设置临时变量[VAR]为[STRING]","_set thread var [VAR] to [STRING]":"设置线程变量[VAR]为[STRING]","_thread var [VAR]":"线程变量[VAR]","_thread var [VAR] exists?":"线程变量[VAR]是否存在？"}});/* end generated l10n code */(function (Scratch) {
  "use strict";

  // Credit to skyhigh173 for the idea of this.
  const label = (name, hidden) => ({
    blockType: Scratch.BlockType.LABEL,
    text: name,
    hideFromPalette: hidden,
  });

  class TempVars {
    constructor() {
      // this.resetRuntimeVariables would be preferable but,
      // its easier on TS when defined in the constructor,
      // and not abstracted out.
      //
      // Object.create(null) prevents "variable [toString]" from returning a function.
      this.runtimeVariables = Object.create(null);

      Scratch.vm.runtime.on("PROJECT_START", () => {
        this.resetRuntimeVariables();
      });

      Scratch.vm.runtime.on("PROJECT_STOP_ALL", () => {
        this.resetRuntimeVariables();
      });
    }

    getInfo() {
      return {
        id: "lmsTempVars2",
        name: Scratch.translate("Temporary Variables"),
        color1: "#FF791A",
        color2: "#E15D00",
        blocks: [
          label(Scratch.translate("Thread Variables"), false),

          {
            opcode: "setThreadVariable",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set thread var [VAR] to [STRING]"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
              STRING: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "0",
              },
            },
          },
          {
            opcode: "changeThreadVariable",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("change thread var [VAR] by [NUM]"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
              NUM: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "1",
              },
            },
          },

          "---",

          {
            opcode: "getThreadVariable",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("thread var [VAR]"),
            disableMonitor: true,
            allowDropAnywhere: true,
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
            },
          },
          {
            opcode: "threadVariableExists",
            blockType: Scratch.BlockType.BOOLEAN,
            text: Scratch.translate("thread var [VAR] exists?"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
            },
          },

          "---",

          {
            opcode: "forEachThreadVariable",
            blockType: Scratch.BlockType.LOOP,
            text: Scratch.translate("for [VAR] in [NUM]"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "thread variable",
              },
              NUM: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "10",
              },
            },
          },
          {
            opcode: "listThreadVariables",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("active thread variables"),
            disableMonitor: true,
          },

          "---",

          label(Scratch.translate("Runtime Variables"), false),

          {
            opcode: "setRuntimeVariable",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set runtime var [VAR] to [STRING]"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
              STRING: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "0",
              },
            },
          },
          {
            opcode: "changeRuntimeVariable",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("change runtime var [VAR] by [NUM]"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
              NUM: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "1",
              },
            },
          },

          "---",

          {
            opcode: "getRuntimeVariable",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("runtime var [VAR]"),
            disableMonitor: true,
            allowDropAnywhere: true,
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
            },
          },
          {
            opcode: "runtimeVariableExists",
            blockType: Scratch.BlockType.BOOLEAN,
            text: Scratch.translate("runtime var [VAR] exists?"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
            },
          },

          "---",

          {
            opcode: "deleteRuntimeVariable",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("delete runtime var [VAR]"),
            arguments: {
              VAR: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "variable",
              },
            },
          },
          {
            opcode: "deleteAllRuntimeVariables",
            func: "resetRuntimeVariables",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("delete all runtime variables"),
          },
          {
            opcode: "listRuntimeVariables",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("active runtime variables"),
          },
        ],
      };
    }

    /* THREAD VARIABLES */

    setThreadVariable(args, util) {
      const thread = util.thread;
      if (!thread.variables) {
        thread.variables = Object.create(null);
      }
      thread.variables[args.VAR] = args.STRING;
    }

    changeThreadVariable(args, util) {
      const thread = util.thread;
      if (!thread.variables) {
        thread.variables = Object.create(null);
      }
      const vars = thread.variables;
      const prev = Scratch.Cast.toNumber(vars[args.VAR]);
      const next = Scratch.Cast.toNumber(args.NUM);
      vars[args.VAR] = prev + next;
    }

    getThreadVariable(args, util) {
      const thread = util.thread;
      if (!thread.variables) {
        thread.variables = Object.create(null);
      }
      return thread.variables[args.VAR] ?? "";
    }

    threadVariableExists(args, util) {
      const thread = util.thread;
      if (!thread.variables) {
        thread.variables = Object.create(null);
      }
      return Object.prototype.hasOwnProperty.call(thread.variables, args.VAR);
    }

    forEachThreadVariable(args, util) {
      const thread = util.thread;
      if (!thread.variables) {
        thread.variables = Object.create(null);
      }
      const vars = thread.variables;
      if (!Object.prototype.hasOwnProperty.call(util.stackFrame, "index")) {
        util.stackFrame.index = 0;
      }
      if (util.stackFrame.index < Number(args.NUM)) {
        util.stackFrame.index++;
        vars[args.VAR] = util.stackFrame.index;
        return true;
      }
    }

    listThreadVariables(args, util) {
      const thread = util.thread;
      if (!thread.variables) {
        thread.variables = Object.create(null);
      }
      return Object.keys(thread.variables).join(",");
    }

    /* RUNTIME VARIABLES */

    setRuntimeVariable(args) {
      this.runtimeVariables[args.VAR] = args.STRING;
    }

    changeRuntimeVariable(args) {
      const prev = Scratch.Cast.toNumber(this.runtimeVariables[args.VAR]);
      const next = Scratch.Cast.toNumber(args.NUM);
      this.runtimeVariables[args.VAR] = prev + next;
    }

    getRuntimeVariable(args) {
      return this.runtimeVariables[args.VAR] ?? "";
    }

    runtimeVariableExists(args) {
      return Object.prototype.hasOwnProperty.call(
        this.runtimeVariables,
        args.VAR
      );
    }

    listRuntimeVariables(args, util) {
      return Object.keys(this.runtimeVariables).join(",");
    }

    deleteRuntimeVariable(args) {
      Reflect.deleteProperty(this.runtimeVariables, args.VAR);
    }

    resetRuntimeVariables() {
      this.runtimeVariables = Object.create(null);
    }
  }
  // The expose format follows TurboWarp's convention of `ext_${extensionId}`.
  // Expose the extension on runtime for others to use.
  const extension = new TempVars();
  Scratch.vm.runtime.ext_lmsTempVars2 = extension;
  Scratch.extensions.register(extension);
})(Scratch);
